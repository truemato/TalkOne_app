================================================================================
                            TalkOne アーキテクチャ図
                                ASCII Art版
================================================================================

【システム全体構成図】

    ┌─────────────────────────────────────────────────────────────┐
    │                         TalkOne App                          │
    │                    完全匿名音声通話アプリ                    │
    └─────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                      Flutter Frontend                        │
    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
    │  │  Home   │──│Matching │──│PreCall  │──│VoiceCall│      │
    │  │ Screen  │  │ Screen  │  │ Screen  │  │ Screen  │      │
    │  └─────────┘  └─────────┘  └─────────┘  └─────────┘      │
    │       │             │            │             │            │
    │       └─────────────┴────────────┴─────────────┘            │
    │                         │                                    │
    │  ┌─────────────────────▼──────────────────────┐            │
    │  │             Service Layer                   │            │
    │  │  ・UserProfile  ・CallMatching  ・Agora    │            │
    │  │  ・Rating      ・Evaluation    ・History   │            │
    │  └─────────────────────────────────────────────┘            │
    └─────────────────────────────────────────────────────────────┘
                                   │
           ┌───────────────────────┼───────────────────────┐
           │                       │                       │
           ▼                       ▼                       ▼
    ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
    │   Firebase   │      │  Agora RTC   │      │ Google Cloud │
    │              │      │              │      │              │
    │ ・Auth       │      │ ・音声通話   │      │ ・Cloud Run  │
    │ ・Firestore  │      │ ・WebRTC     │      │ ・VOICEVOX   │
    │ ・Vertex AI  │      │              │      │              │
    └──────────────┘      └──────────────┘      └──────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │                    AI Services                            │
    │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │
    │  │Gemini 2.5  │  │Gemini 2.0  │  │  VOICEVOX  │        │
    │  │   Flash    │  │Flash Live  │  │            │        │
    │  └────────────┘  └────────────┘  └────────────┘        │
    └──────────────────────────────────────────────────────────┘


【マッチングフロー図】

    ユーザーA                                          ユーザーB
        │                                                  │
        ▼                                                  ▼
    ┌─────────┐                                      ┌─────────┐
    │  Home   │                                      │  Home   │
    │ Screen  │                                      │ Screen  │
    └────┬────┘                                      └────┬────┘
         │ マッチング開始                                  │
         ▼                                                 ▼
    ┌─────────┐     Firebase Firestore              ┌─────────┐
    │Matching │◀────────────────────────────────────▶│Matching │
    │ Screen  │      matchingRequests                │ Screen  │
    └────┬────┘                                      └────┬────┘
         │                                                 │
         │              マッチング成立！                   │
         ▼                                                 ▼
    ┌─────────┐                                      ┌─────────┐
    │PreCall  │     相手のプロフィール表示           │PreCall  │
    │ Screen  │     （3秒カウントダウン）            │ Screen  │
    └────┬────┘                                      └────┬────┘
         │                                                 │
         ▼                                                 ▼
    ┌─────────┐        Agora WebRTC                 ┌─────────┐
    │ Voice   │◀═══════════════════════════════════▶│ Voice   │
    │  Call   │        音声通話（3分間）             │  Call   │
    └────┬────┘                                      └────┬────┘
         │                                                 │
         ▼                                                 ▼
    ┌─────────┐                                      ┌─────────┐
    │  評価   │     お互いに5段階評価                │  評価   │
    │ Screen  │                                      │ Screen  │
    └─────────┘                                      └─────────┘


【レーティングシステム】

    初期値: 1000
         │
         ▼
    ┌─────────────────────────────────────────┐
    │         通常マッチング範囲               │
    │            880 - 9999                    │
    └─────────────────────────────────────────┘
                      │
                      │ レート850以下
                      ▼
    ┌─────────────────────────────────────────┐
    │      AI救済システム（自動）              │
    │         850以下 → AI強制                │
    │    AIは必ず星3評価 → 段階的回復        │
    └─────────────────────────────────────────┘
                      │
                      │ レート880超え
                      ▼
    ┌─────────────────────────────────────────┐
    │         人間マッチング復帰               │
    └─────────────────────────────────────────┘


【AI音声処理フロー】

    ┌──────────┐
    │  マイク  │
    └─────┬────┘
          │ 音声入力
          ▼
    ┌──────────────────────┐     ┌──────────────────────┐
    │   Speech to Text     │     │  Platform Specific   │
    │                      │     │ iOS: SpeechToText   │
    │                      │◀────│ Android: Native     │
    └──────────┬───────────┘     └──────────────────────┘
               │ テキスト変換
               ▼
    ┌──────────────────────┐
    │  Gemini 2.5 Flash    │
    │  ・80文字制限        │
    │  ・ずんだもんペルソナ│
    │  ・高速レスポンス    │
    └──────────┬───────────┘
               │ AI応答テキスト
               ▼
    ┌──────────────────────┐     ┌──────────────────────┐
    │   Text to Speech     │     │   音声合成選択       │
    │                      │◀────│ ・System TTS        │
    │                      │     │ ・VOICEVOX          │
    └──────────┬───────────┘     └──────────────────────┘
               │ 音声データ
               ▼
    ┌──────────┐
    │スピーカー│
    └──────────┘


【データベース構造】

    Firebase Firestore
    │
    ├─ userProfiles/
    │   └─ {userId}/
    │       ├─ nickname: string
    │       ├─ gender: string
    │       ├─ birthday: timestamp
    │       ├─ rating: number (1000)
    │       ├─ iconPath: string
    │       ├─ themeIndex: number
    │       └─ aiMemory: string
    │
    ├─ userRatings/
    │   └─ {userId}/
    │       ├─ currentRating: number
    │       ├─ positiveStreak: number
    │       ├─ negativeStreak: number
    │       └─ lastRatingDirection: string
    │
    ├─ callHistories/
    │   └─ {userId}/
    │       └─ calls/
    │           └─ {callId}/
    │               ├─ partnerId: string
    │               ├─ partnerName: string
    │               ├─ timestamp: timestamp
    │               ├─ duration: number
    │               ├─ myRating: number
    │               └─ partnerRating: number
    │
    └─ matchingRequests/
        └─ {requestId}/
            ├─ userId: string
            ├─ userRating: number
            ├─ timestamp: timestamp
            ├─ status: string
            └─ conversationTheme: string


【画面遷移フロー】

    START
      │
      ▼
    [権限チェック]──拒否──▶ [権限拒否画面]
      │
      │許可
      ▼
    [認証チェック]──未認証──▶ [ログイン画面]
      │
      │認証済
      ▼
    [ホーム画面] ◀──────────────────┐
      │    │                        │
      │    ├──▶ [設定画面]         │
      │    │                        │
      │    ├──▶ [履歴画面]         │
      │    │                        │
      │    └──▶ [プロフィール画面] │
      │                             │
      ▼                             │
    [マッチング画面]                │
      │                             │
      ├─通常マッチ─▶ [プリコール]  │
      │                   │         │
      └─AIマッチ──▶ [AIプリコール]│
                          │         │
                          ▼         │
                    [通話画面]      │
                          │         │
                          ▼         │
                    [評価画面]      │
                          │         │
                          ▼         │
                [再マッチ/ホーム] ──┘


【技術スタック詳細】

    ┌─────────────────────────────────────────────────────────┐
    │                    Frontend (Flutter)                    │
    ├─────────────────────────────────────────────────────────┤
    │ ・Flutter 3.x        ・flutter_svg                     │
    │ ・Material Design 3  ・lottie                          │
    │ ・google_fonts       ・intl                            │
    └─────────────────────────────────────────────────────────┘
                                │
    ┌─────────────────────────────────────────────────────────┐
    │                      Backend Services                    │
    ├─────────────────────────────────────────────────────────┤
    │ ・Firebase Auth      ・Cloud Functions                  │
    │ ・Firestore DB       ・Vertex AI                       │
    │ ・Cloud Run          ・SendGrid                        │
    └─────────────────────────────────────────────────────────┘
                                │
    ┌─────────────────────────────────────────────────────────┐
    │                    音声・通話技術                        │
    ├─────────────────────────────────────────────────────────┤
    │ ・Agora RTC SDK 6.x  ・flutter_tts                     │
    │ ・WebRTC             ・VOICEVOX Engine                 │
    │ ・speech_to_text     ・Android Native SpeechRecognizer │
    └─────────────────────────────────────────────────────────┘
                                │
    ┌─────────────────────────────────────────────────────────┐
    │                      AI Services                         │
    ├─────────────────────────────────────────────────────────┤
    │ ・Gemini 2.5 Flash   ・VOICEVOX (ずんだもん)          │
    │ ・Gemini 2.0 Flash Live ・System TTS                   │
    └─────────────────────────────────────────────────────────┘


【セキュリティ・権限】

    iOS権限:
    ┌──────────────┐     ┌──────────────┐
    │ マイク権限   │     │音声認識権限  │
    │ (必須)       │     │ (必須)       │
    └──────────────┘     └──────────────┘

    Android権限:
    ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
    │ マイク権限   │     │音声認識権限  │     │インターネット│
    │ (必須)       │     │ (必須)       │     │ (必須)       │
    └──────────────┘     └──────────────┘     └──────────────┘


================================================================================
                                  以上
================================================================================