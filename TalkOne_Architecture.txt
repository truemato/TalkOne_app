================================================================================
                            TalkOne アーキテクチャ設計書
                                  Version 1.0
                                2025年1月27日
================================================================================

■ 1. システム概要
================================================================================

TalkOneは完全匿名で音声通話ができる革新的なソーシャルアプリケーションです。
レーティングベースのマッチングシステムにより、質の高い会話体験を提供します。

主要特徴：
- 3分間の匿名音声通話セッション
- レーティングベースマッチング（初期値1000）
- AI救済システム（レート850以下でAI自動マッチング）
- リアルタイム音声認識・AI応答機能
- 5段階評価による動的レーティングシステム


■ 2. アーキテクチャ図（ASCII）
================================================================================

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   TalkOne Architecture                               │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────── Client Layer (Flutter) ──────────────────────────────────┐
│                                                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Screens    │  │   Screens    │  │   Screens    │  │   Screens    │          │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤  ├──────────────┤          │
│  │ • HomeScreen │  │ • Matching   │  │ • VoiceCall  │  │ • Evaluation │          │
│  │ • Settings   │  │ • PreCall    │  │ • AI Chat    │  │ • History    │          │
│  │ • Profile    │  │              │  │ • Zundamon   │  │              │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                  │                  │                  │                  │
│  ┌──────┴──────────────────┴──────────────────┴──────────────────┴───────┐         │
│  │                           Services Layer                                │         │
│  ├────────────────────────────────────────────────────────────────────────┤         │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │         │
│  │ │UserProfile  │ │CallMatching │ │ AgoraCall   │ │ Rating      │      │         │
│  │ │Service      │ │Service      │ │ Service     │ │ Service     │      │         │
│  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │         │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │         │
│  │ │Evaluation   │ │CallHistory  │ │Conversation │ │ VoiceVox    │      │         │
│  │ │Service      │ │Service      │ │DataService  │ │ Service     │      │         │
│  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │         │
│  └────────────────────────────────────────────────────────────────────────┘         │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────── Backend Services ────────────────────────────────────────┐
│                                                                                      │
│  ┌────────────────────┐     ┌────────────────────┐     ┌────────────────────┐     │
│  │    Firebase        │     │   Agora RTC        │     │  Google Cloud      │     │
│  ├────────────────────┤     ├────────────────────┤     ├────────────────────┤     │
│  │ • Authentication   │     │ • Voice/Video      │     │ • Cloud Run        │     │
│  │ • Firestore DB    │     │ • Real-time        │     │ • VOICEVOX Engine  │     │
│  │ • Cloud Functions │     │ • Token Service    │     │ • Agora Token Svc  │     │
│  │ • AI (Vertex AI)  │     │                    │     │                    │     │
│  └─────────┬──────────┘     └─────────┬──────────┘     └─────────┬──────────┘     │
│            │                           │                           │                │
└────────────┴───────────────────────────┴───────────────────────────┴────────────────┘
                                        │
┌─────────────────────────── AI Services Layer ───────────────────────────────────────┐
│                                                                                      │
│  ┌────────────────────┐     ┌────────────────────┐     ┌────────────────────┐     │
│  │  Gemini 2.5 Flash  │     │ Gemini 2.0 Flash   │     │   VOICEVOX        │     │
│  ├────────────────────┤     │      Live          │     ├────────────────────┤     │
│  │ • Text Generation  │     ├────────────────────┤     │ • ずんだもん      │     │
│  │ • 80 char limit   │     │ • Voice Synthesis  │     │ • 四国めたん      │     │
│  │ • User Memory     │     │ • System TTS       │     │ • Other voices    │     │
│  └────────────────────┘     └────────────────────┘     └────────────────────┘     │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘


■ 3. データフロー
================================================================================

3.1 通常マッチングフロー
------------------------
User → HomeScreen → MatchingScreen → PreCallScreen → VoiceCallScreen 
→ EvaluationScreen → RematchOrHomeScreen → HomeScreen

3.2 AI救済フロー（レート850以下）
---------------------------------
User → HomeScreen → MatchingScreen → AI Auto Match → AiPreCallScreen 
→ ZundamonChatScreen → HomeScreen

3.3 音声処理フロー
------------------
1. 音声入力: マイク → Speech Recognition (iOS: SpeechToText, Android: Native)
2. テキスト処理: Gemini 2.5 Flash (80文字制限)
3. 音声合成: System TTS / VOICEVOX
4. 音声出力: スピーカー


■ 4. コンポーネント詳細
================================================================================

4.1 Client Layer (Flutter)
--------------------------
【画面構成】
- HomeScreen: メイン画面、レート表示、マッチング開始
- MatchingScreen: マッチング待機画面
- PreCallScreen: 相手プロフィール表示（3秒）
- VoiceCallScreen: 音声通話画面（3分タイマー）
- EvaluationScreen: 5段階評価画面
- HistoryScreen: 通話履歴一覧
- ProfileScreen: プロフィール編集
- SettingsScreen: テーマ設定、各種設定

【サービス層】
- UserProfileService: ユーザープロフィール管理
- CallMatchingService: マッチングロジック実装
- AgoraCallService: Agora SDK統合、音声通話制御
- RatingService: レーティング計算ロジック
- EvaluationService: 評価データ管理
- CallHistoryService: 通話履歴管理
- ConversationDataService: 会話データ保存
- VoiceVoxService: 音声合成サービス

4.2 Backend Services
--------------------
【Firebase】
- Authentication: 匿名認証
- Firestore: データベース
  - userProfiles: ユーザープロフィール
  - userRatings: レーティングデータ
  - callHistories: 通話履歴
  - matchingRequests: マッチングリクエスト
  - conversationSessions: 会話セッション
- Cloud Functions: 通報システム、管理機能
- Vertex AI: Gemini AI統合

【Agora RTC】
- リアルタイム音声通話
- WebRTC基盤
- グローバルネットワーク

【Google Cloud Run】
- VOICEVOX Engine: 音声合成エンジン
- Agora Token Service: トークン生成
- Matching Service: マッチングロジック

4.3 AI Services
---------------
【Gemini 2.5 Flash】
- テキスト生成AI
- 80文字制限応答
- ユーザーメモリー機能
- 高速レスポンス

【Gemini 2.0 Flash Live】
- 音声合成プロンプト生成
- リアルタイム処理
- 自然な会話生成

【VOICEVOX】
- ずんだもん (speaker_id: 3)
- 四国めたん (speaker_id: 2)
- その他キャラクターボイス


■ 5. レーティングシステム
================================================================================

5.1 基本仕様
------------
- デフォルト値: 1000
- 評価範囲: 星1〜5
- AI自動マッチング: 850以下
- 人間復帰: 880超え

5.2 レート変動ロジック
----------------------
【マイナス評価（星1-2）】
連続回数による下降幅: [3, 9, 15, 21, 27, 33, 39, 45, 51, 57]

【プラス評価（星3-5）】
星数 × 連続倍率: [1, 2, 4, 8, 16]

【特殊ルール】
- 評価方向が変わると連続カウントリセット
- AI通話時: 自分に星3相当（+1ポイント）付与


■ 6. 技術スタック
================================================================================

【フロントエンド】
- Flutter 3.x (Dart)
- Material Design 3
- Provider / Riverpod

【バックエンド】
- Firebase (Authentication, Firestore, Functions)
- Google Cloud Run
- Node.js / Python

【音声・通話】
- Agora RTC SDK 6.x
- WebRTC
- speech_to_text
- flutter_tts

【AI・機械学習】
- Firebase AI (Vertex AI)
- Gemini 2.5 Flash
- Gemini 2.0 Flash Live
- VOICEVOX

【その他】
- GitHub Actions (CI/CD)
- Docker
- SendGrid (メール通知)


■ 7. セキュリティ・プライバシー
================================================================================

7.1 匿名性の確保
----------------
- Firebase匿名認証
- 個人情報非公開
- プロフィール最小限（ニックネーム、性別、誕生日）

7.2 データ保護
--------------
- HTTPS通信
- Firestore Security Rules
- 会話データの暗号化

7.3 権限管理
------------
【iOS】
- マイク権限
- 音声認識権限

【Android】
- マイク権限
- 音声認識権限
- インターネット権限


■ 8. 今後の開発予定
================================================================================

【高優先度】
- アメニティ機能（レート上昇による特典）
- プッシュ通知システム
- 包括的テストスイート

【中優先度】
- 詳細な統計・分析機能
- 管理者ダッシュボード
- 多言語対応

【低優先度】
- グループ通話機能
- カスタマイゼーション拡張
- ソーシャル機能


■ 9. パフォーマンス指標
================================================================================

【目標値】
- マッチング時間: 10秒以内
- 音声遅延: 200ms以下
- AI応答時間: 1秒以内
- アプリ起動時間: 2秒以内

【現在の実測値】
- マッチング時間: 5-15秒
- 音声遅延: 150-300ms
- AI応答時間: 0.5-1.5秒
- アプリ起動時間: 1.5-3秒


================================================================================
                                    以上
================================================================================